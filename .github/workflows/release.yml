name: Export + Release dataset

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g. v0.2.0). If empty, patch version is auto-bumped."
        required: false
        type: string
  schedule:
    # Weekly, Mondays 03:15 UTC
    - cron: "15 3 * * 1"

permissions:
  contents: write

jobs:
  export:
    # Avoid double-running when this workflow itself creates/pushes a tag.
    if: ${{ !(github.event_name == 'push' && github.actor == 'github-actions[bot]') }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Determine release tag
        id: tag
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_REF_TYPE:-}" == "tag" ]]; then
            TAG="${GITHUB_REF_NAME}"
          elif [[ -n "${{ inputs.tag || '' }}" ]]; then
            TAG="${{ inputs.tag }}"
          else
            # Auto-bump: find latest vX.Y.Z tag → bump patch
            LATEST=$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -1)
            if [[ -z "$LATEST" ]]; then
              TAG="v0.1.0"
            else
              # Split v0.1.2 → 0 1 2, bump patch
              BASE="${LATEST#v}"
              MAJOR="${BASE%%.*}"
              REST="${BASE#*.}"
              MINOR="${REST%%.*}"
              PATCH="${REST#*.}"
              PATCH=$((PATCH + 1))
              TAG="v${MAJOR}.${MINOR}.${PATCH}"
            fi
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Using tag: $TAG"

      - name: Create and push tag (if needed)
        if: ${{ github.ref_type != 'tag' }}
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          TAG="${{ steps.tag.outputs.tag }}"
          if git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
            echo "Tag already exists locally: ${TAG}"
          else
            git tag -a "${TAG}" -m "Automated secret mapping export"
          fi
          git push origin "${TAG}"

      - name: Clone TruffleHog
        run: |
          git clone --depth=1 https://github.com/trufflesecurity/trufflehog.git trufflehog

      - name: Clone Gitleaks
        run: |
          git clone --depth=1 https://github.com/gitleaks/gitleaks.git gitleaks

      - name: Run tests (including external integration checks)
        env:
          RUN_EXTERNAL_INTEGRATION: "1"
          TH_ROOT: ./trufflehog/pkg/detectors
          GL_PATH: ./gitleaks/config/gitleaks.toml
        run: go test -v ./...

      - name: Build exporter
        run: go build -o hogwash .

      - name: Generate datasets
        id: generate
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          # Full export + machine-readable stats
          ./hogwash \
            -trufflehog ./trufflehog/pkg/detectors/ \
            -gitleaks ./gitleaks/config/gitleaks.toml \
            -mode full \
            -out dist/secret-mapping.full.json \
            -stats-json dist/full-stats.json \
            -force

          # Gondolin export derived from full export (no second upstream extraction)
          ./hogwash \
            -from-full dist/secret-mapping.full.json \
            -mode gondolin \
            -out dist/secret-mapping.gondolin.json \
            -stats-json dist/gondolin-stats.json \
            -force

          sha256sum dist/secret-mapping.full.json      | awk '{print $1}' > dist/secret-mapping.full.json.sha256
          sha256sum dist/secret-mapping.gondolin.json  | awk '{print $1}' > dist/secret-mapping.gondolin.json.sha256

          TH_SHA=$(git -C trufflehog rev-parse --short HEAD)
          GL_SHA=$(git -C gitleaks rev-parse --short HEAD)
          TH_SHA_FULL=$(git -C trufflehog rev-parse HEAD)
          GL_SHA_FULL=$(git -C gitleaks rev-parse HEAD)
          SELF_SHA=$(git rev-parse HEAD)

          # Extract stats from JSON
          TOTAL_SERVICES=$(jq -r '.combined.total_services' dist/full-stats.json)
          SERVICES_WITH_HOSTS=$(jq -r '.combined.services_with_hosts' dist/full-stats.json)
          TOTAL_RULES=$(jq -r '.combined.total_rules' dist/full-stats.json)

          KEYWORD_HOSTS=$(jq -r '.gondolin.keyword_host_mappings' dist/gondolin-stats.json)
          EXACT_NAME_HOSTS=$(jq -r '.gondolin.exact_name_mappings' dist/gondolin-stats.json)
          VALUE_PATTERNS=$(jq -r '.gondolin.value_patterns' dist/gondolin-stats.json)
          LINKED_PATTERNS=$(jq -r '.gondolin.linked_patterns' dist/gondolin-stats.json)

          # Write outputs for release step
          echo "th_sha=${TH_SHA}" >> "$GITHUB_OUTPUT"
          echo "gl_sha=${GL_SHA}" >> "$GITHUB_OUTPUT"
          echo "total_services=${TOTAL_SERVICES}" >> "$GITHUB_OUTPUT"
          echo "services_with_hosts=${SERVICES_WITH_HOSTS}" >> "$GITHUB_OUTPUT"
          echo "total_rules=${TOTAL_RULES}" >> "$GITHUB_OUTPUT"
          echo "keyword_hosts=${KEYWORD_HOSTS}" >> "$GITHUB_OUTPUT"
          echo "exact_name_hosts=${EXACT_NAME_HOSTS}" >> "$GITHUB_OUTPUT"
          echo "value_patterns=${VALUE_PATTERNS}" >> "$GITHUB_OUTPUT"
          echo "linked_patterns=${LINKED_PATTERNS}" >> "$GITHUB_OUTPUT"

          cat > dist/metadata.json <<EOF
          {
            "release_tag": "${{ steps.tag.outputs.tag }}",
            "generated_at_utc": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "repo": {
              "name": "${GITHUB_REPOSITORY}",
              "sha": "${SELF_SHA}"
            },
            "sources": {
              "trufflehog": {"repo": "trufflesecurity/trufflehog", "sha": "${TH_SHA_FULL}"},
              "gitleaks": {"repo": "gitleaks/gitleaks", "sha": "${GL_SHA_FULL}"}
            }
          }
          EOF

      - name: Upload workflow artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: secret-mapping-${{ steps.tag.outputs.tag }}
          path: |
            dist/secret-mapping.full.json
            dist/secret-mapping.full.json.sha256
            dist/secret-mapping.gondolin.json
            dist/secret-mapping.gondolin.json.sha256
            dist/full-stats.json
            dist/gondolin-stats.json
            dist/metadata.json

      - name: Create/update GitHub release + upload assets
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TAG="${{ steps.tag.outputs.tag }}"

          GL_SHA="${{ steps.generate.outputs.gl_sha }}"
          TH_SHA="${{ steps.generate.outputs.th_sha }}"

          NOTES="Auto-generated from upstream sources.

          | Source | Commit |
          |--------|--------|
          | gitleaks | [\`${GL_SHA}\`](https://github.com/gitleaks/gitleaks/commit/${GL_SHA}) |
          | trufflehog | [\`${TH_SHA}\`](https://github.com/trufflesecurity/trufflehog/commit/${TH_SHA}) |

          **Full:** ${{ steps.generate.outputs.total_services }} services, ${{ steps.generate.outputs.services_with_hosts }} with hosts, ${{ steps.generate.outputs.total_rules }} regex rules
          **Gondolin:** ${{ steps.generate.outputs.keyword_hosts }} keyword→host, ${{ steps.generate.outputs.exact_name_hosts }} exact-name→host, ${{ steps.generate.outputs.value_patterns }} value patterns (${{ steps.generate.outputs.linked_patterns }} with host linkage)"

          # Dedent (heredoc indentation)
          NOTES=$(echo "$NOTES" | sed 's/^          //')

          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release edit "$TAG" --notes "$NOTES"
          else
            gh release create "$TAG" \
              --title "$TAG" \
              --notes "$NOTES" \
              --verify-tag
          fi

          gh release upload "$TAG" \
            dist/secret-mapping.full.json \
            dist/secret-mapping.full.json.sha256 \
            dist/secret-mapping.gondolin.json \
            dist/secret-mapping.gondolin.json.sha256 \
            dist/metadata.json \
            --clobber

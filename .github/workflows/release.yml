name: Export + Release dataset

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to create/use (e.g. v20260208-223000). If empty, an auto tag is generated."
        required: false
        type: string
  schedule:
    # Weekly, Mondays 03:15 UTC
    - cron: "15 3 * * 1"

permissions:
  contents: write

jobs:
  export:
    # Avoid double-running when this workflow itself creates/pushes a tag.
    if: ${{ !(github.event_name == 'push' && github.actor == 'github-actions[bot]') }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Determine release tag
        id: tag
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_REF_TYPE:-}" == "tag" ]]; then
            TAG="${GITHUB_REF_NAME}"
          elif [[ -n "${{ inputs.tag || '' }}" ]]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="v$(date -u +%Y%m%d-%H%M%S)"
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Using tag: $TAG"

      - name: Create and push tag (if needed)
        if: ${{ github.ref_type != 'tag' }}
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          TAG="${{ steps.tag.outputs.tag }}"
          if git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
            echo "Tag already exists locally: ${TAG}"
          else
            git tag -a "${TAG}" -m "Automated secret mapping export"
          fi
          git push origin "${TAG}"

      - name: Clone TruffleHog
        run: |
          git clone --depth=1 https://github.com/trufflesecurity/trufflehog.git trufflehog

      - name: Clone Gitleaks
        run: |
          git clone --depth=1 https://github.com/gitleaks/gitleaks.git gitleaks

      - name: Run tests (includes integration tests when repos are present)
        run: go test -v ./...

      - name: Build exporter
        run: go build -o hogwash .

      - name: Generate datasets
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          # Full export (all data, for exploration/debugging)
          ./hogwash \
            -trufflehog ./trufflehog/pkg/detectors/ \
            -gitleaks ./gitleaks/config/gitleaks.toml \
            -mode full \
            -out dist/secret-mapping.full.json \
            -force

          # Gondolin export (slim, for pi-gondolin.ts consumption)
          ./hogwash \
            -trufflehog ./trufflehog/pkg/detectors/ \
            -gitleaks ./gitleaks/config/gitleaks.toml \
            -mode gondolin \
            -out dist/secret-mapping.gondolin.json \
            -force

          sha256sum dist/secret-mapping.full.json     | awk '{print $1}' > dist/secret-mapping.full.json.sha256
          sha256sum dist/secret-mapping.gondolin.json  | awk '{print $1}' > dist/secret-mapping.gondolin.json.sha256

          TH_SHA=$(git -C trufflehog rev-parse HEAD)
          GL_SHA=$(git -C gitleaks rev-parse HEAD)
          SELF_SHA=$(git rev-parse HEAD)

          cat > dist/metadata.json <<EOF
          {
            "release_tag": "${{ steps.tag.outputs.tag }}",
            "generated_at_utc": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "repo": {
              "name": "${GITHUB_REPOSITORY}",
              "sha": "${SELF_SHA}"
            },
            "sources": {
              "trufflehog": {"repo": "trufflesecurity/trufflehog", "sha": "${TH_SHA}"},
              "gitleaks": {"repo": "gitleaks/gitleaks", "sha": "${GL_SHA}"}
            }
          }
          EOF

      - name: Upload workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: secret-mapping-${{ steps.tag.outputs.tag }}
          path: |
            dist/secret-mapping.full.json
            dist/secret-mapping.full.json.sha256
            dist/secret-mapping.gondolin.json
            dist/secret-mapping.gondolin.json.sha256
            dist/metadata.json

      - name: Create/update GitHub release + upload assets
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TAG="${{ steps.tag.outputs.tag }}"

          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release exists: $TAG"
          else
            gh release create "$TAG" \
              --title "$TAG" \
              --notes "Automated export from TruffleHog + Gitleaks." \
              --verify-tag
          fi

          gh release upload "$TAG" \
            dist/secret-mapping.full.json \
            dist/secret-mapping.full.json.sha256 \
            dist/secret-mapping.gondolin.json \
            dist/secret-mapping.gondolin.json.sha256 \
            dist/metadata.json \
            --clobber
